<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <meta name="theme-color" content="#1e3a8a"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <!-- Cache busting ‚Äì always load latest version -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Library Zgharta Zewyeh</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300..700&display=swap" rel="stylesheet"/>
  <style>
    /* ... (keep all your existing CSS exactly as is ‚Äì unchanged) ... */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary:      #1e3a8a;
      --primary-light:#3b82f6;
      --primary-soft: #dbeafe;
      --white:        #ffffff;
      --black:        #111111;
      --gray-light:   #f8fafc;
      --gray-border:  #e2e8f0;
      --gray-text:    #475569;
      --font-sans:    'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --radius:       12px;
      --hdr:          60px;
      --nav-w:        280px;
    }

    html {
      scroll-behavior: smooth;
      overscroll-behavior: none;
      height: 100%;
    }

    /* ‚îÄ‚îÄ FULL PAGE BACKGROUND ‚îÄ‚îÄ */
    body {
      font-family: var(--font-sans);
      background:
        linear-gradient(160deg,
          rgba(8,18,58,0.93) 0%,
          rgba(15,35,90,0.89) 50%,
          rgba(30,58,138,0.86) 100%),
        url('https://raw.githubusercontent.com/maykelkhouryyammine/library/main/bluebackground.webp') center / cover no-repeat fixed;
      color: var(--black);
      min-height: 100%;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      overflow-x: hidden;
    }

    button { font-family: var(--font-sans); cursor: pointer; background: none; border: none; }
    img { display: block; max-width: 100%; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); border-radius: 99px; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed; bottom: 80px; left: 50%;
      transform: translateX(-50%) translateY(10px);
      background: var(--black); color: white;
      padding: 8px 18px; border-radius: 40px;
      font-size: 13px; font-weight: 500; white-space: nowrap;
      z-index: 9999; opacity: 0; pointer-events: none;
      transition: opacity 0.2s, transform 0.2s;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ‚îÄ‚îÄ NAV DRAWER ‚îÄ‚îÄ */
    .nav-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 500;
      opacity: 0; pointer-events: none; transition: opacity 0.25s; backdrop-filter: blur(3px);
    }
    .nav-overlay.open { opacity: 1; pointer-events: all; }
    .nav-drawer {
      position: fixed; top: 0; left: 0; bottom: 0; width: var(--nav-w);
      background: var(--white); border-right: 1px solid var(--gray-border);
      z-index: 510; transform: translateX(-100%); transition: transform 0.25s ease;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .nav-drawer.open { transform: translateX(0); }
    .nav-header {
      padding: 18px 16px; border-bottom: 1px solid var(--gray-border);
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }
    .nav-brand { font-weight: 700; font-size: 16px; color: var(--primary); line-height: 1.3; }
    .nav-sub { font-size: 10px; color: var(--gray-text); margin-top: 2px; }
    .nav-close {
      width: 32px; height: 32px; border-radius: 50%; background: var(--gray-light);
      font-size: 15px; display: flex; align-items: center; justify-content: center; color: var(--black);
      flex-shrink: 0;
    }
    .nav-links { padding: 6px 0; border-bottom: 1px solid var(--gray-border); flex-shrink: 0; }
    .nav-link {
      display: flex; align-items: center; gap: 10px; padding: 12px 16px;
      font-size: 14px; font-weight: 500; color: var(--black); width: 100%;
      border-left: 3px solid transparent; text-align: left;
    }
    .nav-link.active { border-left-color: var(--primary); background: var(--primary-soft); color: var(--primary); }
    .nav-cat-label {
      padding: 14px 16px 6px; font-size: 10px; font-weight: 700;
      color: var(--gray-text); letter-spacing: 0.08em; text-transform: uppercase; flex-shrink: 0;
    }
    .nav-cats { flex: 1; overflow-y: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
    .nav-cat {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 16px; width: 100%; font-size: 13px; color: var(--black);
      border-left: 3px solid transparent; text-align: left;
    }
    .nav-cat.active { border-left-color: var(--primary); background: var(--primary-soft); color: var(--primary); }
    .nav-cat-left { display: flex; align-items: center; gap: 8px; }
    .nav-cat-count {
      font-size: 10px; color: var(--gray-text); background: var(--gray-light);
      padding: 2px 7px; border-radius: 30px; flex-shrink: 0;
    }
    .nav-footer { padding: 14px 16px; border-top: 1px solid var(--gray-border); font-size: 10px; color: var(--gray-text); flex-shrink: 0; }

    /* ‚îÄ‚îÄ HEADER (frosted glass) ‚îÄ‚îÄ */
    #header {
      position: sticky; top: 0; z-index: 200;
      background: rgba(255,255,255,0.93);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(230,235,245,0.8);
      height: var(--hdr); flex-shrink: 0;
    }
    .header-inner {
      display: flex; align-items: center; padding: 0 12px; height: 100%;
      max-width: 640px; margin: 0 auto; gap: 8px;
    }
    .hamburger {
      width: 38px; height: 38px; border-radius: 8px; background: var(--white);
      border: 1px solid var(--gray-border); display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 5px; flex-shrink: 0;
    }
    .hamburger span { width: 18px; height: 1.5px; background: var(--black); border-radius: 2px; }
    .logo {
      flex: 1; font-weight: 700; font-size: 15px; color: var(--black);
      cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0;
    }
    .logo small { font-size: 11px; font-weight: 400; color: var(--gray-text); margin-left: 4px; }
    .header-right { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
    .search-btn {
      width: 38px; height: 38px; border-radius: 8px; border: 1px solid var(--gray-border);
      background: var(--white); font-size: 15px; display: flex; align-items: center; justify-content: center;
    }
    .cart-btn {
      background: var(--black); color: white; border-radius: 30px;
      padding: 7px 14px; font-size: 13px; font-weight: 600;
      display: flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    .cart-badge {
      background: white; color: var(--black); font-size: 10px; font-weight: 700;
      min-width: 18px; height: 18px; border-radius: 30px; padding: 0 4px;
      display: none; align-items: center; justify-content: center;
    }
    .cart-badge.show { display: flex; }

    /* ‚îÄ‚îÄ SEARCH OVERLAY ‚îÄ‚îÄ */
    .search-overlay {
      position: fixed; inset: 0; z-index: 600; background: rgba(0,0,0,0.5);
      display: none; flex-direction: column; backdrop-filter: blur(4px);
    }
    .search-overlay.open { display: flex; }
    .search-bar {
      background: var(--white); padding: 10px 12px;
      display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--gray-border);
    }
    .search-bar input {
      flex: 1; border: none; outline: none; font-size: 16px; background: transparent; font-family: var(--font-sans);
    }
    .search-cancel { font-size: 13px; font-weight: 600; color: var(--primary); padding: 4px 8px; }
    .search-area { flex: 1; background: var(--white); overflow-y: auto; padding: 0 12px 80px; -webkit-overflow-scrolling: touch; }
    .search-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 0;
      border-bottom: 1px solid var(--gray-border); cursor: pointer;
    }
    .search-item:active { background: var(--gray-light); margin: 0 -12px; padding: 12px; }
    .search-img-wrap {
      width: 48px; height: 48px; border-radius: 8px; background: var(--gray-light);
      flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 20px;
    }
    .search-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
    .search-info { flex: 1; min-width: 0; }
    .search-name { font-size: 13px; font-weight: 500; color: var(--black); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-category { font-size: 11px; color: var(--gray-text); margin-top: 2px; }
    .search-price { font-size: 13px; font-weight: 700; color: var(--black); flex-shrink: 0; }
    .search-msg { text-align: center; padding: 50px 20px; color: var(--gray-text); font-size: 14px; }

    /* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
    #app { flex: 1; max-width: 640px; margin: 0 auto; padding: 0 0 24px; width: 100%; }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.18s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

    /* ‚îÄ‚îÄ HERO (glass card on dark bg) ‚îÄ‚îÄ */
    .hero {
      margin: 12px 12px 0; border-radius: var(--radius);
      padding: 40px 24px; min-height: 200px;
      display: flex; flex-direction: column; justify-content: flex-end;
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.14); color: white;
    }
    .hero-eyebrow { font-size: 11px; letter-spacing: 0.12em; margin-bottom: 10px; color: rgba(255,255,255,0.65); text-transform: uppercase; font-weight: 500; }
    .hero-title { font-size: 30px; font-weight: 800; line-height: 1.15; margin-bottom: 10px; letter-spacing: -0.02em; }
    .hero-sub { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 20px; line-height: 1.6; }
    .hero-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: white; color: var(--primary); border-radius: 40px;
      padding: 11px 22px; font-size: 14px; font-weight: 700;
      cursor: pointer; align-self: flex-start; touch-action: manipulation;
      transition: transform 0.15s;
    }
    .hero-btn:active { transform: scale(0.96); }

    /* ‚îÄ‚îÄ SECTION HEADERS ‚îÄ‚îÄ */
    .section-header { display: flex; align-items: baseline; justify-content: space-between; padding: 20px 12px 8px; }
    .section-title { font-size: 19px; font-weight: 700; color: white; }
    .section-link { font-size: 13px; color: rgba(255,255,255,0.7); font-weight: 500; }
    .cat-strip { display: flex; gap: 8px; overflow-x: auto; padding: 0 12px 10px; scrollbar-width: none; }
    .cat-strip::-webkit-scrollbar { display: none; }
    .cat-pill {
      background: rgba(255,255,255,0.12); border: 1.5px solid rgba(255,255,255,0.2);
      border-radius: 40px; padding: 8px 16px; font-size: 13px; font-weight: 500;
      white-space: nowrap; cursor: pointer; color: white; touch-action: manipulation;
      backdrop-filter: blur(4px); transition: background 0.15s;
    }
    .cat-pill:active { background: rgba(255,255,255,0.25); }

    /* ‚îÄ‚îÄ ITEMS GRID ‚îÄ‚îÄ */
    .items-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 4px 12px 0; }
    @media (min-width: 480px) { .items-grid { grid-template-columns: repeat(3,1fr); } }

    .item-card {
      background: rgba(255,255,255,0.97);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: var(--radius); overflow: hidden;
      transition: transform 0.15s;
    }
    .item-card:active { transform: scale(0.98); }

    .item-image {
      aspect-ratio: 1/1; background: #eef1f6;
      position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }
    .item-image > img {
      position: absolute; inset: 0; width: 100%; height: 100%;
      object-fit: cover; display: block; opacity: 0;
      transition: opacity 0.35s ease;
    }
    .item-image > img.loaded { opacity: 1; }
    .fallback-icon {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 100%; font-size: 36px; color: var(--primary-light);
      position: absolute; inset: 0;
    }
    .sale-badge {
      position: absolute; top: 8px; left: 8px; background: var(--black);
      color: white; font-size: 9px; font-weight: 800; padding: 3px 7px;
      border-radius: 30px; z-index: 3; letter-spacing: 0.04em;
    }
    .item-info { padding: 10px; }
    .item-category { font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--gray-text); margin-bottom: 3px; letter-spacing: 0.05em; }
    .item-name {
      font-size: 13px; font-weight: 500; margin-bottom: 10px; color: var(--black);
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden; line-height: 1.4;
    }
    .item-footer { display: flex; align-items: center; justify-content: space-between; }
    .item-price { font-size: 14px; font-weight: 700; color: var(--black); display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
    .old-price { font-size: 11px; font-weight: 400; color: var(--gray-text); text-decoration: line-through; }
    .add-button {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--white); border: 1.5px solid var(--black); color: var(--black);
      font-size: 20px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: background 0.15s, color 0.15s;
      touch-action: manipulation; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .add-button.added { background: var(--black); color: white; }
    .add-button:active { transform: scale(0.88); }

    /* ‚îÄ‚îÄ SKELETON ‚îÄ‚îÄ */
    .skeleton-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 4px 12px; }
    @media (min-width: 480px) { .skeleton-grid { grid-template-columns: repeat(3,1fr); } }
    .skeleton-card { background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.13); border-radius: var(--radius); overflow: hidden; }
    .skeleton-img {
      width: 100%; aspect-ratio: 1/1;
      background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.14) 50%, rgba(255,255,255,0.05) 100%);
      background-size: 200% 100%; animation: shimmer 1.4s infinite ease-in-out;
    }
    .skeleton-line {
      height: 12px;
      background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.14) 50%, rgba(255,255,255,0.05) 100%);
      background-size: 200% 100%; animation: shimmer 1.4s infinite ease-in-out;
      border-radius: 4px; margin: 8px 8px 4px;
    }
    .skeleton-line.short { width: 55%; margin-bottom: 10px; }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* ‚îÄ‚îÄ CATEGORY PAGE ‚îÄ‚îÄ */
    .cat-header { padding: 16px 12px 8px; border-bottom: 1px solid rgba(255,255,255,0.13); }
    .cat-title-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
    .cat-title { font-size: 22px; font-weight: 700; color: white; }
    .home-icon {
      background: rgba(255,255,255,0.15); border-radius: 50%;
      width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
      font-size: 14px; color: white; flex-shrink: 0; touch-action: manipulation;
    }
    .cat-count { font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 2px; }
    .filter-bar { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 12px 2px; align-items: center; }
    .sort-select {
      padding: 7px 12px; border: 1px solid rgba(255,255,255,0.22); border-radius: 40px;
      font-size: 13px; background: rgba(255,255,255,0.11); color: white;
      font-family: var(--font-sans); outline: none; cursor: pointer;
    }
    .sort-select option { background: #1e3a8a; color: white; }
    .sale-toggle {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.11); border: 1px solid rgba(255,255,255,0.22); border-radius: 40px;
      padding: 7px 12px; font-size: 13px; cursor: pointer; color: white; user-select: none;
    }
    .sale-toggle input { margin: 0; width: 15px; height: 15px; accent-color: white; cursor: pointer; }

    /* ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ */
    .pagination { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 24px 12px 12px; flex-wrap: wrap; }
    .page-btn {
      width: 36px; height: 36px; border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.22); background: rgba(255,255,255,0.11);
      font-size: 13px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: white; touch-action: manipulation;
    }
    .page-btn.active { background: white; color: var(--primary); border-color: white; font-weight: 700; }
    .page-btn.dots { border: none; pointer-events: none; color: rgba(255,255,255,0.45); }
    .nav-btn {
      display: flex; align-items: center; gap: 4px; padding: 8px 14px;
      border: 1px solid rgba(255,255,255,0.22); border-radius: 40px;
      background: rgba(255,255,255,0.11); font-size: 13px; font-weight: 500;
      cursor: pointer; color: white; touch-action: manipulation;
    }
    .nav-btn:disabled { opacity: 0.3; pointer-events: none; }

    /* ‚îÄ‚îÄ BACK TO TOP ‚îÄ‚îÄ */
    .back-to-top {
      position: fixed; bottom: 20px; right: 14px; width: 42px; height: 42px;
      background: var(--black); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; cursor: pointer; z-index: 300;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
      opacity: 0; pointer-events: none; transition: opacity 0.25s;
      touch-action: manipulation;
    }
    .back-to-top.visible { opacity: 1; pointer-events: all; }

    /* ‚îÄ‚îÄ ABOUT & CONTACT ‚îÄ‚îÄ */
    .page-wrap { padding: 12px; }
    .about-hero {
      background: rgba(255,255,255,0.07); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.14);
      color: white; border-radius: var(--radius); padding: 30px 22px; margin-bottom: 12px;
    }
    .about-hero h1 { font-size: 26px; font-weight: 700; margin-bottom: 8px; }
    .about-hero p { color: rgba(255,255,255,0.8); font-size: 14px; line-height: 1.6; }
    .card {
      background: rgba(255,255,255,0.97); border: 1px solid rgba(255,255,255,0.3);
      border-radius: var(--radius); padding: 18px; margin-bottom: 12px;
    }
    .card h2 { font-size: 15px; font-weight: 700; color: var(--black); margin-bottom: 12px; }
    .card p { font-size: 13px; color: var(--gray-text); margin-bottom: 6px; line-height: 1.6; }
    .values-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .value-item { border-left: 3px solid var(--primary); padding-left: 10px; }
    .value-item h3 { font-size: 13px; font-weight: 600; color: var(--black); margin-bottom: 2px; }
    .value-item p { font-size: 11px; color: var(--gray-text); margin: 0; }

    .form-field {
      width: 100%; padding: 11px 14px; border: 1px solid var(--gray-border);
      border-radius: 10px; margin-bottom: 10px; font-size: 14px;
      font-family: var(--font-sans); outline: none; color: var(--black);
      transition: border-color 0.15s; background: white;
    }
    .form-field:focus { border-color: var(--primary); }
    .submit-btn {
      background: var(--black); color: white; border: none;
      padding: 13px; width: 100%; border-radius: 40px; font-weight: 600;
      font-size: 14px; cursor: pointer; font-family: var(--font-sans);
      touch-action: manipulation; transition: opacity 0.15s;
    }
    .submit-btn:active { opacity: 0.8; }

    /* ‚îÄ‚îÄ CART DRAWER ‚îÄ‚îÄ */
    .cart-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 700;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .cart-overlay.open { opacity: 1; pointer-events: all; }
    .cart-drawer {
      position: fixed; top: 0; right: 0; bottom: 0; width: min(360px,100%);
      background: var(--white); z-index: 710; transform: translateX(100%);
      transition: transform 0.25s ease; display: flex; flex-direction: column;
      border-left: 1px solid var(--gray-border);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .cart-drawer.open { transform: translateX(0); }
    .cart-header {
      padding: 16px 18px; border-bottom: 1px solid var(--gray-border);
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }
    .cart-header h2 { font-size: 18px; font-weight: 700; color: var(--black); }
    .cart-close {
      width: 32px; height: 32px; border-radius: 50%; background: var(--gray-light);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; color: var(--black); touch-action: manipulation;
    }
    .cart-items { flex: 1; overflow-y: auto; padding: 0 18px; -webkit-overflow-scrolling: touch; }
    .cart-empty {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; padding: 60px 20px; color: var(--gray-text); text-align: center;
    }
    .cart-empty p { margin: 10px 0 16px; font-size: 14px; }
    .cart-empty-btn {
      background: var(--black); color: white; border: none; border-radius: 40px;
      padding: 10px 22px; font-size: 13px; font-weight: 600;
      cursor: pointer; font-family: var(--font-sans); touch-action: manipulation;
    }
    .cart-item {
      display: flex; align-items: center; gap: 12px; padding: 14px 0;
      border-bottom: 1px solid var(--gray-border);
    }
    .cart-item-image {
      width: 52px; height: 52px; border-radius: 8px; background: var(--gray-light);
      display: flex; align-items: center; justify-content: center; font-size: 22px;
      flex-shrink: 0; overflow: hidden;
    }
    .cart-item-image img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .cart-item-info { flex: 1; min-width: 0; }
    .cart-item-name { font-size: 13px; font-weight: 600; color: var(--black); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cart-item-category { font-size: 11px; color: var(--gray-text); margin-top: 1px; }
    .cart-item-price { font-size: 13px; font-weight: 700; color: var(--black); margin-top: 3px; }
    .cart-qty { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
    /* qty buttons ‚Äì delegation handles clicks, NO inline onclick */
    .qty-btn {
      width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--gray-border);
      background: var(--white); display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 600; color: var(--black); cursor: pointer;
      touch-action: manipulation; user-select: none; flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .qty-btn:active { background: var(--gray-light); transform: scale(0.9); }
    .qty-btn[data-action="remove"] { color: #dc2626; border-color: #fca5a5; font-size: 14px; }
    .qty-num { min-width: 24px; text-align: center; font-size: 14px; font-weight: 700; color: var(--black); }
    .cart-footer { padding: 16px 18px; border-top: 1px solid var(--gray-border); background: var(--white); flex-shrink: 0; }
    .cart-total { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; font-weight: 700; font-size: 17px; color: var(--black); }

    /* ‚îÄ‚îÄ WhatsApp btn ‚Äì BLACK ‚îÄ‚îÄ */
    .whatsapp-btn {
      width: 100%; padding: 13px; background: var(--black); border: none;
      border-radius: 40px; font-size: 14px; font-weight: 700; cursor: pointer;
      color: white; font-family: var(--font-sans); margin-bottom: 8px;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      touch-action: manipulation; transition: opacity 0.15s;
    }
    .whatsapp-btn:active { opacity: 0.75; }

    .clear-btn {
      width: 100%; padding: 12px; background: var(--white); border: 1px solid var(--gray-border);
      border-radius: 40px; font-size: 13px; font-weight: 500; cursor: pointer;
      color: var(--gray-text); font-family: var(--font-sans); touch-action: manipulation;
    }
    .clear-btn:active { background: var(--gray-light); }

    /* ‚îÄ‚îÄ REFRESH BAR ‚îÄ‚îÄ */
    .refresh-bar { height: 3px; background: rgba(255,255,255,0.08); position: relative; overflow: hidden; display: none; }
    .refresh-bar.active { display: block; }
    .refresh-bar::after {
      content:''; position:absolute; top:0; left:-40%;
      width:40%; height:100%; background:rgba(255,255,255,0.65);
      animation: slide 1.2s infinite ease-in-out;
    }
    @keyframes slide { 0%{left:-40%} 100%{left:110%} }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state .icon { font-size: 44px; margin-bottom: 10px; }
    .empty-state p { color: rgba(255,255,255,0.8); font-size: 14px; }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    footer {
      background: rgba(5,12,40,0.65);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.65); padding: 28px 16px;
      text-align: center; flex-shrink: 0;
    }
    .footer-logo { font-weight: 800; font-size: 18px; color: white; margin-bottom: 4px; }
    .footer-sub { font-size: 11px; margin-bottom: 14px; color: rgba(255,255,255,0.5); }
    .footer-links { display: flex; justify-content: center; gap: 20px; margin-bottom: 14px; flex-wrap: wrap; }
    .footer-links button { color: rgba(255,255,255,0.65); font-size: 12px; font-weight: 500; touch-action: manipulation; }
    .footer-copy { font-size: 11px; color: rgba(255,255,255,0.4); }
    .footer-copy a { color: white; text-decoration: none; font-weight: 600; }
  </style>
</head>
<body>

<div id="toast" role="status" aria-live="polite"></div>
<div class="refresh-bar" id="refreshBar"></div>

<!-- NAV DRAWER -->
<div class="nav-overlay" id="navOverlay"></div>
<nav class="nav-drawer" id="navDrawer" aria-label="Main navigation">
  <div class="nav-header">
    <div>
      <div class="nav-brand">Library Zgharta Zawyeh</div>
      <div class="nav-sub">Educational Resources ¬∑ Lebanon</div>
    </div>
    <button class="nav-close" id="navCloseBtn" aria-label="Close navigation">‚úï</button>
  </div>
  <div class="nav-links">
    <button class="nav-link active" id="navHome">üè† Home</button>
    <button class="nav-link" id="navAbout">‚ÑπÔ∏è About</button>
    <button class="nav-link" id="navContact">üìû Contact</button>
  </div>
  <div class="nav-cat-label">Browse Categories</div>
  <div class="nav-cats" id="navCats"></div>
  <div class="nav-footer">¬© 2026 Library Zgharta Zewyeh</div>
</nav>

<!-- HEADER -->
<header id="header">
  <div class="header-inner">
    <button class="hamburger" id="hamburgerBtn" aria-label="Open menu">
      <span></span><span></span><span></span>
    </button>
    <div class="logo" id="logoBtn">Library Zgharta Zawyeh <small>Lebanon</small></div>
    <div class="header-right">
      <button class="search-btn" id="searchOpenBtn" aria-label="Search">üîç</button>
      <button class="cart-btn" id="cartOpenBtn" aria-label="Open cart">
        üõí <span class="cart-badge" id="cartBadge"></span>
      </button>
    </div>
  </div>
</header>

<!-- SEARCH OVERLAY -->
<div class="search-overlay" id="searchOverlay" role="dialog" aria-label="Search">
  <div class="search-bar">
    <span aria-hidden="true">üîç</span>
    <input type="search" id="searchInput" placeholder="Search items..." autocomplete="off" aria-label="Search items">
    <button class="search-cancel" id="searchCancelBtn">Cancel</button>
  </div>
  <div class="search-area" id="searchResults">
    <div class="search-msg">Start typing to search‚Ä¶</div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">

  <!-- HOME -->
  <div id="page-home" class="page active">
    <div class="hero">
      <div class="hero-eyebrow">‚ú¶ Welcome to</div>
      <div class="hero-title">Library Zgharta Zewyeh</div>
      <div class="hero-sub">Books, stationery, art supplies &amp; educational resources for curious minds.</div>
      <button class="hero-btn" id="heroBrowseBtn">Browse Collection ‚Üí</button>
    </div>
    <div class="section-header"><span class="section-title">Categories</span></div>
    <div class="cat-strip" id="homeCategories"></div>
    <div class="section-header" style="margin-top:4px">
      <span class="section-title">Featured</span>
      <button class="section-link" id="viewAllBtn">View all</button>
    </div>
    <div>
      <div class="skeleton-grid" id="featuredSkeleton">
        <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>
        <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>
        <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>
        <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>
      </div>
      <div class="items-grid" id="featuredGrid" style="display:none;"></div>
    </div>
  </div>

  <!-- CATEGORY -->
  <div id="page-category" class="page">
    <div class="cat-header">
      <div class="cat-title-row">
        <span class="cat-title" id="categoryTitle">All Items</span>
        <button class="home-icon" id="catHomeBtn" aria-label="Go home">‚åÇ</button>
      </div>
      <div class="cat-count" id="categoryCount"></div>
    </div>
    <div class="filter-bar">
      <select class="sort-select" id="sortSelect" aria-label="Sort items">
        <option value="default">Sort by</option>
        <option value="price-asc">Price: Low ‚Üí High</option>
        <option value="price-desc">Price: High ‚Üí Low</option>
        <option value="name-asc">Name: A ‚Üí Z</option>
        <option value="name-desc">Name: Z ‚Üí A</option>
      </select>
      <label class="sale-toggle">
        <input type="checkbox" id="saleToggle"> Sale only
      </label>
    </div>
    <div>
      <div class="skeleton-grid" id="categorySkeleton">
        <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>
        <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>
        <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>
        <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-line"></div><div class="skeleton-line short"></div></div>
      </div>
      <div class="items-grid" id="categoryGrid" style="display:none;"></div>
      <div class="empty-state" id="categoryEmpty" style="display:none;">
        <div class="icon">üì¶</div><p>No items found</p>
      </div>
    </div>
    <div id="paginationContainer"></div>
  </div>

  <!-- ABOUT -->
  <div id="page-about" class="page">
    <div class="page-wrap">
      <div class="about-hero">
        <h1>About Us</h1>
        <p>Library Zgharta Zawyeh ‚Äì supporting education in Lebanon with quality books, stationery, art supplies, and gifts.</p>
      </div>
      <div class="card">
        <h2>Our Story</h2>
        <p>Founded to provide students, teachers, and lifelong learners with carefully selected educational materials. Every person deserves access to quality tools for learning and creativity.</p>
      </div>
      <div class="card">
        <h2>Location &amp; Hours</h2>
        <p>üìç Lebanon</p>
        <p>‚è∞ Monday‚ÄìSaturday 9:00‚Äì19:00</p>
        <p>‚è∞ Sunday 10:00‚Äì17:00</p>
        <p>üìû +961 76 419 154</p>
      </div>
      <div class="card">
        <h2>Our Values</h2>
        <div class="values-grid">
          <div class="value-item"><h3>Quality</h3><p>Only the best products</p></div>
          <div class="value-item"><h3>Knowledge</h3><p>Supporting learning</p></div>
          <div class="value-item"><h3>Community</h3><p>Proudly local</p></div>
          <div class="value-item"><h3>Creativity</h3><p>Inspiring ideas</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTACT -->
  <div id="page-contact" class="page">
    <div class="page-wrap">
      <div class="card">
        <h2>Send a Message</h2>
        <div id="contactForm">
          <input type="text"  class="form-field" placeholder="Your name"      id="contactName">
          <input type="text"  class="form-field" placeholder="Phone or email" id="contactInfo">
          <textarea           class="form-field" placeholder="Your message"   id="contactMsg" rows="4" style="resize:vertical;"></textarea>
          <button class="submit-btn" id="contactSubmitBtn">Send Message</button>
        </div>
        <div id="contactSuccess" style="display:none; text-align:center; padding:24px 10px;">
          <div style="font-size:42px; margin-bottom:10px;">‚úÖ</div>
          <h3 style="font-size:17px; margin-bottom:6px;">Message Sent!</h3>
          <p style="font-size:13px; color:var(--gray-text); margin-bottom:16px;">We'll get back to you soon.</p>
          <button id="contactResetBtn" style="background:none; border:1.5px solid var(--black); color:var(--black); padding:9px 22px; border-radius:40px; font-weight:600; cursor:pointer; font-family:var(--font-sans); font-size:13px;">Send Another</button>
        </div>
      </div>
    </div>
  </div>

</div><!-- /#app -->

<button class="back-to-top" id="backToTop" aria-label="Back to top">‚Üë</button>

<!-- CART DRAWER -->
<div class="cart-overlay" id="cartOverlay"></div>
<div class="cart-drawer" id="cartDrawer" role="dialog" aria-label="Shopping bag">
  <div class="cart-header">
    <h2>Your Bag</h2>
    <button class="cart-close" id="cartCloseBtn" aria-label="Close cart">‚úï</button>
  </div>
  <div class="cart-items" id="cartItemsList"></div>
  <div class="cart-footer" id="cartFooter" style="display:none;">
    <div class="cart-total"><span>Total</span><span id="cartTotal">$0.00</span></div>
    <button class="whatsapp-btn" id="whatsappOrderBtn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/>
        <path d="M12 0C5.373 0 0 5.373 0 12c0 2.625.846 5.059 2.28 7.043L.787 23.267 5.2 21.8C7.124 23.185 9.464 24 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 22c-2.322 0-4.482-.716-6.267-1.939l-.449-.287-3.146 1.006.986-3.058-.302-.479C1.72 16.434 1 14.3 1 12 1 5.925 5.925 1 12 1s11 4.925 11 11-4.925 11-11 11z"/>
      </svg>
      Order via WhatsApp
    </button>
    <button class="clear-btn" id="clearCartBtn">Clear Bag</button>
  </div>
</div>

<!-- FOOTER -->
<footer>
  <div class="footer-logo">Library Zgharta Zawyeh</div>
  <div class="footer-sub">Educational Resources ¬∑ Lebanon</div>
  <div class="footer-links">
    <button id="footerHome">Home</button>
    <button id="footerShop">Shop</button>
    <button id="footerAbout">About</button>
    <button id="footerContact">Contact</button>
  </div>
  <div class="footer-copy">
    ¬© 2026 Library Zgharta Zawyeh ‚Äî Developed &amp; designed by
    <a href="https://maykelkhouryyammine.github.io" target="_blank" rel="noopener">MaykelYammine</a>
  </div>
</footer>

<script>
/* ============================================================
   CONFIG
   ============================================================ */
const SHEET_API    = "https://script.google.com/macros/s/AKfycbzcRmLESKsO5SpkkJXdaP8XopAnaOcb9rFfYBcJz2UItLkJTrkcQST9XDSVHebVGRBw5w/exec";
const PER_PAGE     = 20;
const CACHE_KEY    = "ly_v10_data";
const CACHE_TS_KEY = "ly_v10_ts";
const CACHE_TTL    = 5 * 60 * 1000;
const WHATSAPP_NUM = "96176419154"; // +961 76 419 154

/* ============================================================
   STATE
   ============================================================ */
let allItems       = [];
let categories     = [];
let categoryCounts = {};
let dataReady      = false;
let currentPage    = "home";
let currentCat     = "all";
let currentPageNum = 1;
let sortOption     = "default";
let saleOnly       = false;
let cart           = [];

/* shorthand */
const $ = id => document.getElementById(id);

/* ============================================================
   BOOT
   ============================================================ */
wireEvents();
loadData();

/* ============================================================
   DATA LOADING  (stale-while-revalidate for instant display)
   ============================================================ */
async function loadData() {
  let hasCached = false;

  // ‚ë† Serve cache immediately (even if stale)
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw).map(normalizeItem).filter(i => i.name);
      if (parsed.length) {
        allItems  = parsed;
        dataReady = true;
        hasCached = true;
        onDataLoaded();
      }
    }
  } catch(_) {}

  // ‚ë° Always fetch fresh in background
  const ts      = parseInt(localStorage.getItem(CACHE_TS_KEY) || "0");
  const isStale = Date.now() - ts > CACHE_TTL;

  if (!hasCached || isStale) {
    if (hasCached) showRefreshBar();
    try {
      const res   = await fetch(SHEET_API);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data  = await res.json();
      const fresh = data.map(normalizeItem).filter(i => i.name);
      if (!fresh.length) throw new Error("Empty");

      localStorage.setItem(CACHE_KEY,    JSON.stringify(fresh));
      localStorage.setItem(CACHE_TS_KEY, String(Date.now()));

      const changed =
        JSON.stringify(fresh.map(i => i.id)) !==
        JSON.stringify(allItems.map(i => i.id));

      allItems  = fresh;
      dataReady = true;

      if (!hasCached || changed) {
        onDataLoaded();
        if (currentPage === "category") renderCategoryPage();
      }
    } catch(err) {
      console.error("Sheet fetch failed:", err);
      if (!hasCached) showError("Could not load products. Check your connection and refresh.");
    } finally {
      hideRefreshBar();
    }
  }
}

function normalizeItem(item) {
  return {
    id:          String(item.id || item.name || Math.random().toString(36).slice(2)),
    name:        String(item.name        || "").trim(),
    category:    String(item.category    || "Other").trim(),
    price:       parseFloat(item.price)  || 0,
    salePrice:   item.salePrice ? parseFloat(item.salePrice) : null,
    onSale:      ["true","TRUE",true].includes(item.onSale),
    featured:    ["true","TRUE",true].includes(item.featured),
    available:   !["false","FALSE",false].includes(item.available),
    image_url:   String(item.image_url   || "").trim(),
    description: String(item.description || "").trim()
  };
}

function onDataLoaded() {
  computeCategories();
  renderNavCategories();
  renderHomeCategories();
  renderFeatured();
}

function computeCategories() {
  const map = {};
  allItems.filter(i => i.available).forEach(i => {
    map[i.category] = (map[i.category] || 0) + 1;
  });
  categoryCounts = map;
  categories     = Object.keys(map).sort();
}

/* ============================================================
   EVENT WIRING  ‚Äî zero inline onclick in HTML
   ============================================================ */
function wireEvents() {
  // Nav
  $("hamburgerBtn").addEventListener("click", openNav);
  $("navCloseBtn").addEventListener("click",  closeNav);
  $("navOverlay").addEventListener("click",   closeNav);
  $("navHome").addEventListener("click",    () => { closeNav(); goHome(); });
  $("navAbout").addEventListener("click",   () => { closeNav(); showPage("about"); });
  $("navContact").addEventListener("click", () => { closeNav(); showPage("contact"); });

  // Logo
  $("logoBtn").addEventListener("click", goHome);

  // Search
  $("searchOpenBtn").addEventListener("click",  openSearch);
  $("searchCancelBtn").addEventListener("click", closeSearch);
  $("searchInput").addEventListener("input", debounce(performSearch, 220));

  // Cart open / close
  $("cartOpenBtn").addEventListener("click",  openCart);
  $("cartCloseBtn").addEventListener("click", closeCart);
  $("cartOverlay").addEventListener("click",  closeCart);
  $("clearCartBtn").addEventListener("click", clearCart);
  $("whatsappOrderBtn").addEventListener("click", orderWhatsApp);

  // ‚îÄ‚îÄ Cart item buttons: EVENT DELEGATION (fixes mobile + re-render) ‚îÄ‚îÄ
  $("cartItemsList").addEventListener("click", function(e) {
    const btn = e.target.closest("[data-action]");
    if (!btn) return;
    e.stopPropagation();
    const { action, id } = btn.dataset;
    if (!id) return;
    if (action === "inc")    updateQuantity(id, +1);
    if (action === "dec")    updateQuantity(id, -1);
    if (action === "remove") removeItem(id);
  });

  // Home
  $("heroBrowseBtn").addEventListener("click", () => showCategory("all", 1));
  $("viewAllBtn").addEventListener("click",    () => showCategory("all", 1));

  // Category
  $("catHomeBtn").addEventListener("click", goHome);
  $("sortSelect").addEventListener("change", e => {
    sortOption = e.target.value; currentPageNum = 1; renderCategoryPage();
  });
  $("saleToggle").addEventListener("change", e => {
    saleOnly = e.target.checked; currentPageNum = 1; renderCategoryPage();
  });

  // Contact
  $("contactSubmitBtn").addEventListener("click", submitContact);
  $("contactResetBtn").addEventListener("click",  resetContact);

  // Back to top
  $("backToTop").addEventListener("click", () => window.scrollTo({ top:0, behavior:"smooth" }));

  // Footer
  $("footerHome").addEventListener("click",    goHome);
  $("footerShop").addEventListener("click",    () => showCategory("all", 1));
  $("footerAbout").addEventListener("click",   () => showPage("about"));
  $("footerContact").addEventListener("click", () => showPage("contact"));

  // Scroll ‚Üí back-to-top
  window.addEventListener("scroll", () => {
    $("backToTop").classList.toggle("visible", window.scrollY > 300);
  }, { passive: true });
  // Global listener for all "add to cart" buttons (prevents double-add)
document.body.addEventListener('click', function(e) {
  const addBtn = e.target.closest('.add-button');
  if (!addBtn) return;
  e.preventDefault();  // Stop any potential double events
  e.stopPropagation();
  
  const itemId = addBtn.dataset.itemId;
  const item = allItems.find(i => i.id === itemId);
  if (!item) return;
  
  addToCart({
    id:        item.id,
    name:      item.name,
    category:  item.category,
    price:     item.salePrice ?? item.price,
    image_url: item.image_url
  });
});
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function openNav() {
  $("navDrawer").classList.add("open");
  $("navOverlay").classList.add("open");
  document.body.style.overflow = "hidden";
}
function closeNav() {
  $("navDrawer").classList.remove("open");
  $("navOverlay").classList.remove("open");
  document.body.style.overflow = "";
}

function showPage(page) {
  currentPage = page;
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  const el = document.getElementById("page-" + page);
  if (el) el.classList.add("active");
  updateNavHighlight();
  window.scrollTo({ top:0, behavior:"instant" });
}

function goHome() {
  currentPage = "home";
  currentCat  = "all";
  showPage("home");
  if (dataReady) renderFeatured();
}

function showCategory(cat, page) {
  currentCat     = cat;
  currentPageNum = page || 1;
  sortOption     = "default";
  saleOnly       = false;
  $("sortSelect").value   = "default";
  $("saleToggle").checked = false;
  showPage("category");
  renderCategoryPage();
}

function updateNavHighlight() {
  document.querySelectorAll(".nav-link").forEach(l => l.classList.remove("active"));
  const map = { home:"navHome", about:"navAbout", contact:"navContact" };
  if (map[currentPage]) $(map[currentPage]).classList.add("active");
  document.querySelectorAll(".nav-cat").forEach(b =>
    b.classList.toggle("active", b.dataset.cat === currentCat)
  );
}

/* ============================================================
   NAV CATEGORIES  (event delegation)
   ============================================================ */
function renderNavCategories() {
  const nav   = $("navCats");
  const total = allItems.filter(i => i.available).length;

  let html = `<button class="nav-cat" data-cat="all">
    <div class="nav-cat-left"><span>All Items</span></div>
    <span class="nav-cat-count">${total}</span>
  </button>`;
  categories.forEach(cat => {
    html += `<button class="nav-cat" data-cat="${escAttr(cat)}">
      <div class="nav-cat-left"><span>${escHTML(cat)}</span></div>
      <span class="nav-cat-count">${categoryCounts[cat]||0}</span>
    </button>`;
  });
  nav.innerHTML = html;
  nav.querySelectorAll(".nav-cat").forEach(btn => {
    btn.addEventListener("click", () => { closeNav(); showCategory(btn.dataset.cat, 1); });
  });
  updateNavHighlight();
}

/* ============================================================
   HOME RENDERING
   ============================================================ */
function renderHomeCategories() {
  const strip = $("homeCategories");
  strip.innerHTML = categories.map(cat =>
    `<div class="cat-pill" role="button" tabindex="0">${escHTML(cat)}</div>`
  ).join("");
  strip.querySelectorAll(".cat-pill").forEach((pill, i) => {
    pill.addEventListener("click", () => showCategory(categories[i], 1));
  });
}

function renderFeatured() {
  if (!dataReady) return;
  const skel = $("featuredSkeleton");
  const grid = $("featuredGrid");

  let featured = allItems.filter(i => i.available && i.featured);
  if (!featured.length) featured = allItems.filter(i => i.available).slice(0, 8);

  grid.innerHTML = featured.map(itemCardHTML).join("");
  
  skel.style.display = "none";
  grid.style.display = "grid";
  // FIX: Initialize lazy images after grid is visible
  initLazyImages(grid);
}

/* ============================================================
   CATEGORY PAGE
   ============================================================ */
function renderCategoryPage() {
  const titleEl = $("categoryTitle");
  const countEl = $("categoryCount");
  const skel    = $("categorySkeleton");
  const grid    = $("categoryGrid");
  const empty   = $("categoryEmpty");
  const pagCon  = $("paginationContainer");

  titleEl.textContent = currentCat === "all" ? "All Items" : currentCat;
  skel.style.display  = "grid";
  grid.style.display  = "none";
  empty.style.display = "none";
  pagCon.innerHTML    = "";

  let items = allItems.filter(i => i.available);
  if (currentCat !== "all") items = items.filter(i => i.category === currentCat);
  if (saleOnly)             items = items.filter(i => i.onSale);
  items = sortItems(items, sortOption);

  const total = items.length;
  countEl.textContent = total === 0 ? "No items" : `${total} item${total!==1?"s":""}`;

  if (!total) {
    skel.style.display  = "none";
    empty.style.display = "block";
    return;
  }

  const totalPages = Math.ceil(total / PER_PAGE);
  const start      = (currentPageNum - 1) * PER_PAGE;
  const pageItems  = items.slice(start, start + PER_PAGE);

  grid.innerHTML     = pageItems.map(itemCardHTML).join("");
 
  skel.style.display = "none";
  grid.style.display = "grid";
  // FIX: Initialize lazy images after grid is visible
  initLazyImages(grid);

  if (totalPages > 1) {
    pagCon.innerHTML = buildPagination(totalPages);
    wirePagination(pagCon);
  }
}

function sortItems(items, sort) {
  const s = [...items];
  if (sort==="price-asc")  s.sort((a,b)=>(a.salePrice??a.price)-(b.salePrice??b.price));
  if (sort==="price-desc") s.sort((a,b)=>(b.salePrice??b.price)-(a.salePrice??a.price));
  if (sort==="name-asc")   s.sort((a,b)=>a.name.localeCompare(b.name));
  if (sort==="name-desc")  s.sort((a,b)=>b.name.localeCompare(a.name));
  return s;
}

function buildPagination(totalPages) {
  let html = '<div class="pagination">';
  html += `<button class="nav-btn" data-pg="${currentPageNum-1}" ${currentPageNum===1?"disabled":""}>‚Üê Prev</button>`;
  const range = [];
  if (totalPages<=7) { for(let i=1;i<=totalPages;i++) range.push(i); }
  else {
    range.push(1);
    if (currentPageNum>3) range.push("‚Ä¶");
    for(let i=Math.max(2,currentPageNum-1); i<=Math.min(totalPages-1,currentPageNum+1); i++) range.push(i);
    if (currentPageNum<totalPages-2) range.push("‚Ä¶");
    range.push(totalPages);
  }
  range.forEach(p => {
    if (p==="‚Ä¶") html+=`<span class="page-btn dots">‚Ä¶</span>`;
    else html+=`<button class="page-btn ${p===currentPageNum?"active":""}" data-pg="${p}">${p}</button>`;
  });
  html+=`<button class="nav-btn" data-pg="${currentPageNum+1}" ${currentPageNum===totalPages?"disabled":""}>Next ‚Üí</button>`;
  html+="</div>";
  return html;
}

function wirePagination(container) {
  container.querySelectorAll("[data-pg]").forEach(btn => {
    btn.addEventListener("click", () => {
      const pg = parseInt(btn.dataset.pg);
      if (!pg || btn.disabled) return;
      currentPageNum = pg;
      window.scrollTo({ top:0, behavior:"smooth" });
      renderCategoryPage();
    });
  });
}

/* ============================================================
   ITEM CARD  (lazy image with smooth fade-in)
   ============================================================ */
function itemCardHTML(item) {
  const name     = escHTML(item.name);
  const cat      = escHTML(item.category);
  const price    = item.salePrice ?? item.price;
  const oldPrice = item.onSale ? item.price : null;
  const inCart   = cart.some(c => c.id === item.id);

  const imageHtml = item.image_url
    ? `<img class="lazy"
            data-src="${escAttr(item.image_url)}"
            src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
            alt="${name}" loading="lazy">
       <div class="fallback-icon" style="display:none;">üìÑ</div>`
    : `<div class="fallback-icon">üìÑ</div>`;

  return `
    <div class="item-card">
      <div class="item-image">
        ${item.onSale ? '<span class="sale-badge">SALE</span>' : ""}
        ${imageHtml}
      </div>
      <div class="item-info">
        <div class="item-category">${cat}</div>
        <div class="item-name">${name}</div>
        <div class="item-footer">
          <div class="item-price">
            ${oldPrice ? `<span class="old-price">$${oldPrice.toFixed(2)}</span>` : ""}
            <span>$${price.toFixed(2)}</span>
          </div>
          <button class="add-button${inCart?" added":""}"
            data-item-id="${escAttr(item.id)}"
            aria-label="Add ${name} to bag"
          >${inCart?"‚úì":"+"}</button>
        </div>
      </div>
    </div>`;
}



/* ============================================================
   LAZY IMAGES  (IntersectionObserver + CSS fade)
   ============================================================ */
let lazyObserver;
function initLazyImages(container) {
  if (!("IntersectionObserver" in window)) {
    container.querySelectorAll("img.lazy[data-src]").forEach(loadImg);
    return;
  }
  if (!lazyObserver) {
    lazyObserver = new IntersectionObserver(entries => {
      entries.forEach(e => { if (e.isIntersecting) { loadImg(e.target); lazyObserver.unobserve(e.target); } });
    }, { rootMargin:"300px" });
  }
  container.querySelectorAll("img.lazy[data-src]").forEach(img => lazyObserver.observe(img));
}

function loadImg(img) {
  if (!img.dataset.src) return;
  const src = img.dataset.src;
  img.removeAttribute("data-src");
  img.src = src;
  img.onload  = () => img.classList.add("loaded");      // triggers CSS opacity: 1
  img.onerror = () => {
    img.style.display = "none";
    const fb = img.nextElementSibling;
    if (fb && fb.classList.contains("fallback-icon")) fb.style.display = "flex";
  };
}

/* ============================================================
   CART
   ============================================================ */
function addToCart(item) {
  const existing = cart.find(c => c.id === item.id);
  if (existing) existing.qty++;
  else cart.push({ ...item, qty:1 });
  updateCartBadge();
  renderCartUI();
  showToast(`${item.name} added to bag`);
  refreshAddButtonState();
}

function updateQuantity(id, delta) {
  const idx = cart.findIndex(c => c.id === id);
  if (idx===-1) return;
  cart[idx].qty += delta;
  if (cart[idx].qty <= 0) cart.splice(idx, 1);
  updateCartBadge();
  renderCartUI();
  refreshAddButtonState();
}

function removeItem(id) {
  cart = cart.filter(c => c.id !== id);
  updateCartBadge();
  renderCartUI();
  refreshAddButtonState();
}

function clearCart() {
  cart = [];
  updateCartBadge();
  renderCartUI();
  refreshAddButtonState();
}

function updateCartBadge() {
  const total = cart.reduce((s,i) => s+i.qty, 0);
  const badge = $("cartBadge");
  badge.textContent = total>99 ? "99+" : String(total);
  badge.classList.toggle("show", total>0);
}

function openCart() {
  // Add loading state as requested
  $("cartItemsList").innerHTML = '<div style="text-align:center; padding:40px; color:var(--gray-text);">Loading your bag...</div>';
  renderCartUI();
  $("cartOverlay").classList.add("open");
  $("cartDrawer").classList.add("open");
  document.body.style.overflow = "hidden";
}
function closeCart() {
  $("cartOverlay").classList.remove("open");
  $("cartDrawer").classList.remove("open");
  document.body.style.overflow = "";
}

function renderCartUI() {
  const list   = $("cartItemsList");
  const footer = $("cartFooter");

  if (!cart.length) {
    list.innerHTML = `
      <div class="cart-empty">
        <div style="font-size:52px;">üõí</div>
        <p>Your bag is empty</p>
        <button class="cart-empty-btn" id="emptyBrowseBtn">Browse Items</button>
      </div>`;
    footer.style.display = "none";
    const eb = document.getElementById("emptyBrowseBtn");
    if (eb) eb.addEventListener("click", () => { closeCart(); showCategory("all",1); });
    return;
  }

  footer.style.display = "block";
  // FIX: Safe price handling
  const total = cart.reduce((s,i) => {
    const price = i.price || 0;
    const qty = i.qty || 0;
    return s + price * qty;
  }, 0);
  $("cartTotal").textContent = "$" + total.toFixed(2);

  // Buttons use data-action + data-id ‚Äî delegation in wireEvents() handles them
  list.innerHTML = cart.map(item => {
    const imgHtml = item.image_url
      ? `<img src="${escAttr(item.image_url)}" alt="${escHTML(item.name)}"
              style="width:100%;height:100%;object-fit:cover;display:block;"
              onerror="this.style.display='none'">`
      : "üìÑ";
    // FIX: Safe price and quantity
    const price = item.price || 0;
    const qty = item.qty || 0;
    const itemTotal = (price * qty).toFixed(2);
    return `
      <div class="cart-item">
        <div class="cart-item-image">${imgHtml}</div>
        <div class="cart-item-info">
          <div class="cart-item-name">${escHTML(item.name)}</div>
          <div class="cart-item-category">${escHTML(item.category)}</div>
          <div class="cart-item-price">$${itemTotal}</div>
        </div>
        <div class="cart-qty">
          <button class="qty-btn" data-action="remove" data-id="${escAttr(item.id)}" aria-label="Remove">üóë</button>
          <button class="qty-btn" data-action="dec"    data-id="${escAttr(item.id)}" aria-label="Decrease">‚àí</button>
          <span class="qty-num">${qty}</span>
          <button class="qty-btn" data-action="inc"    data-id="${escAttr(item.id)}" aria-label="Increase">+</button>
        </div>
      </div>`;
  }).join("");
}

function refreshAddButtonState() {
  document.querySelectorAll(".add-button[data-item-id]").forEach(btn => {
    const inCart = cart.some(c => c.id === btn.dataset.itemId);
    btn.classList.toggle("added", inCart);
    btn.textContent = inCart ? "‚úì" : "+";
  });
}

/* ============================================================
   WHATSAPP ORDER  ‚Äì black button, formatted message
   ============================================================ */
function orderWhatsApp() {
  if (!cart.length) return;
  const total = cart.reduce((s,i) => {
    const price = i.price || 0;
    const qty = i.qty || 0;
    return s + price * qty;
  }, 0);
  const lines = cart.map(i => {
    const price = i.price || 0;
    const qty = i.qty || 0;
    return `‚Ä¢ ${i.name} √ó ${qty} ‚Äî $${(price * qty).toFixed(2)}`;
  }).join("\n");
  const msg   = encodeURIComponent(
    `Hello Library Zgharta Zawyeh! üìö\nI'd like to order:\n\n${lines}\n\n*Total: $${total.toFixed(2)}*`
  );
  window.open(`https://wa.me/${WHATSAPP_NUM}?text=${msg}`, "_blank");
}

/* ============================================================
   SEARCH
   ============================================================ */
function openSearch() {
  $("searchOverlay").classList.add("open");
  document.body.style.overflow = "hidden";
  setTimeout(() => $("searchInput").focus(), 100);
}
function closeSearch() {
  $("searchOverlay").classList.remove("open");
  document.body.style.overflow = "";
  $("searchInput").value = "";
  $("searchResults").innerHTML = '<div class="search-msg">Start typing to search‚Ä¶</div>';
}

function performSearch() {
  const q    = $("searchInput").value.trim().toLowerCase();
  const area = $("searchResults");

  if (!q) { area.innerHTML = '<div class="search-msg">Start typing to search‚Ä¶</div>'; return; }
  if (!dataReady) { area.innerHTML = '<div class="search-msg">Loading‚Ä¶</div>'; return; }

  const matched = allItems.filter(i =>
    i.available && (
      i.name.toLowerCase().includes(q) ||
      i.category.toLowerCase().includes(q) ||
      i.description.toLowerCase().includes(q)
    )
  ).slice(0, 30);

  if (!matched.length) {
    // FIX: More friendly empty search message
    area.innerHTML = `<div class="search-msg">‚ú® No items match "<strong>${escHTML(q)}</strong>"<br>Try different keywords.</div>`;
    return;
  }

  area.innerHTML = matched.map(item => {
    const price   = item.salePrice ?? item.price;
    const imgHtml = item.image_url
      ? `<img src="${escAttr(item.image_url)}" alt="" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">`
      : "üìÑ";
    return `
      <div class="search-item" data-search-id="${escAttr(item.id)}">
        <div class="search-img-wrap">${imgHtml}</div>
        <div class="search-info">
          <div class="search-name">${escHTML(item.name)}</div>
          <div class="search-category">${escHTML(item.category)}</div>
        </div>
        <div class="search-price">$${price.toFixed(2)}</div>
      </div>`;
  }).join("");

  area.querySelectorAll(".search-item").forEach(el => {
    el.addEventListener("click", () => {
      const item = allItems.find(i => i.id === el.dataset.searchId);
      if (!item) return;
      addToCart({ id:item.id, name:item.name, category:item.category,
                  price:item.salePrice??item.price, image_url:item.image_url });
      closeSearch();
    });
  });
}

/* ============================================================
   CONTACT FORM
   ============================================================ */
function submitContact() {
  const name = $("contactName").value.trim();
  const info = $("contactInfo").value.trim();
  const msg  = $("contactMsg").value.trim();
  if (!name || !info || !msg) { showToast("Please fill in all fields"); return; }
  $("contactForm").style.display    = "none";
  $("contactSuccess").style.display = "block";
}
function resetContact() {
  ["contactName","contactInfo","contactMsg"].forEach(id => $(id).value = "");
  $("contactForm").style.display    = "block";
  $("contactSuccess").style.display = "none";
}

/* ============================================================
   TOAST
   ============================================================ */
let toastTimer;
function showToast(msg) {
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove("show"), 2200);
}

/* ============================================================
   REFRESH BAR & ERROR
   ============================================================ */
function showRefreshBar() { $("refreshBar").classList.add("active"); }
function hideRefreshBar() { $("refreshBar").classList.remove("active"); }

function showError(msg) {
  const skel = $("featuredSkeleton");
  const grid = $("featuredGrid");
  skel.style.display = "none";
  grid.innerHTML = `
    <div style="grid-column:1/-1;text-align:center;padding:48px 20px;">
      <div style="font-size:38px;margin-bottom:12px;">‚ö†Ô∏è</div>
      <p style="font-size:14px;color:rgba(255,255,255,0.8);">${escHTML(msg)}</p>
      <button id="retryBtn"
        style="margin-top:16px;background:white;color:var(--primary);border:none;
               padding:10px 24px;border-radius:40px;font-weight:700;cursor:pointer;
               font-family:var(--font-sans);font-size:14px;">Retry</button>
    </div>`;
  grid.style.display = "grid";
  const rb = document.getElementById("retryBtn");
  if (rb) rb.addEventListener("click", () => location.reload());
}

/* ============================================================
   HELPERS
   ============================================================ */
function escHTML(s) {
  return String(s||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function escAttr(s) { return String(s||"").replace(/"/g,"&quot;"); }
function debounce(fn, ms) {
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
}
</script>
</body>
</html>
